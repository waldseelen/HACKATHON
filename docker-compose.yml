version: '3.8'

# ============================================================
# LogSense AI - Docker Compose
# Real-time container log analysis with Gemini AI
# ============================================================

services:

  # ========================
  # INFRASTRUCTURE
  # ========================

  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: logsense-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: logsense
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-changeme}
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  postgres:
    image: postgres:15-alpine
    container_name: logsense-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: logsense
      POSTGRES_USER: logsense
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U logsense"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ========================
  # MONITORING UIs
  # ========================

  dozzle:
    image: amir20/dozzle:latest
    container_name: logsense-dozzle
    ports:
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      DOZZLE_LEVEL: info
      DOZZLE_TAILSIZE: 300
    restart: unless-stopped

  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: logsense-uptime-kuma
    ports:
      - "3001:3001"
    volumes:
      - uptime-kuma-data:/app/data
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: logsense-grafana
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
    volumes:
      - grafana-data:/var/lib/grafana
    depends_on:
      - postgres
    restart: unless-stopped

  # ========================
  # CORE SERVICES
  # ========================

  log-ingestion:
    build:
      context: ./services/ingestion
      dockerfile: Dockerfile
    container_name: logsense-ingestion
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy
    ports:
      - "8000:8000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: logsense
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:-changeme}
      POSTGRES_HOST: postgres
      POSTGRES_DB: logsense
      POSTGRES_USER: logsense
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      LOG_LEVEL: INFO
    restart: unless-stopped

  ai-analysis:
    build:
      context: ./services/ai-analysis
      dockerfile: Dockerfile
    container_name: logsense-ai-analysis
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy
    environment:
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: logsense
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:-changeme}
      POSTGRES_HOST: postgres
      POSTGRES_DB: logsense
      POSTGRES_USER: logsense
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      BATCH_WINDOW_SECONDS: "2"
      MAX_BATCH_SIZE: "50"
      LOG_LEVEL: INFO
    restart: unless-stopped

  alert-composer:
    build:
      context: ./services/alert-composer
      dockerfile: Dockerfile
    container_name: logsense-alert-composer
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy
    ports:
      - "8001:8001"
    environment:
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: logsense
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:-changeme}
      POSTGRES_HOST: postgres
      POSTGRES_DB: logsense
      POSTGRES_USER: logsense
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      FIREBASE_CREDENTIALS: ${FIREBASE_CREDENTIALS_PATH:-/app/firebase-credentials.json}
      UPTIME_KUMA_WEBHOOK: ${UPTIME_KUMA_WEBHOOK_URL:-}
      LOG_LEVEL: INFO
    volumes:
      - ./firebase-credentials.json:/app/firebase-credentials.json:ro
    restart: unless-stopped

  # ========================
  # TEST (run with --profile test)
  # ========================

  log-generator:
    build:
      context: ./test
      dockerfile: Dockerfile.generator
    container_name: logsense-test-generator
    environment:
      INGESTION_URL: http://log-ingestion:8000
      LOGS_PER_SECOND: "10"
    profiles:
      - test
    depends_on:
      - log-ingestion

volumes:
  rabbitmq-data:
  postgres-data:
  uptime-kuma-data:
  grafana-data:

networks:
  default:
    name: logsense-network
