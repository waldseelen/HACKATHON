# ============================================================
# LogSense AI - Docker Compose
# Real-time container log analysis with Gemini AI
# Firebase Edition (Firestore + FCM)
# ============================================================

services:

  # ========================
  # MONITORING UIs
  # ========================

  dozzle:
    image: amir20/dozzle:latest
    container_name: logsense-dozzle
    ports:
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      DOZZLE_LEVEL: info
      DOZZLE_TAILSIZE: 300
    restart: unless-stopped

  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: logsense-uptime-kuma
    ports:
      - "3001:3001"
    volumes:
      - uptime-kuma-data:/app/data
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: logsense-grafana
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
    volumes:
      - grafana-data:/var/lib/grafana
    restart: unless-stopped

  # ========================
  # CORE SERVICES
  # ========================

  log-ingestion:
    build:
      context: ./services/ingestion
      dockerfile: Dockerfile
    container_name: logsense-ingestion
    ports:
      - "8000:8000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./firebase-credentials.json:/app/firebase-credentials.json:ro
    environment:
      FIREBASE_CREDENTIALS_PATH: /app/firebase-credentials.json
      FIREBASE_PROJECT_ID: ${FIREBASE_PROJECT_ID}
      LOG_LEVEL: INFO
    restart: unless-stopped

  ai-analysis:
    build:
      context: ./services/ai-analysis
      dockerfile: Dockerfile
    container_name: logsense-ai-analysis
    volumes:
      - ./firebase-credentials.json:/app/firebase-credentials.json:ro
    environment:
      FIREBASE_CREDENTIALS_PATH: /app/firebase-credentials.json
      FIREBASE_PROJECT_ID: ${FIREBASE_PROJECT_ID}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      BATCH_WINDOW_SECONDS: "2"
      MAX_BATCH_SIZE: "50"
      LOG_LEVEL: INFO
    restart: unless-stopped

  alert-composer:
    build:
      context: ./services/alert-composer
      dockerfile: Dockerfile
    container_name: logsense-alert-composer
    ports:
      - "8001:8001"
    environment:
      FIREBASE_CREDENTIALS_PATH: /app/firebase-credentials.json
      FIREBASE_PROJECT_ID: ${FIREBASE_PROJECT_ID}
      UPTIME_KUMA_WEBHOOK: ${UPTIME_KUMA_WEBHOOK_URL:-}
      LOG_LEVEL: INFO
    volumes:
      - ./firebase-credentials.json:/app/firebase-credentials.json:ro
    restart: unless-stopped

  # ========================
  # TEST (run with --profile test)
  # ========================

  log-generator:
    build:
      context: ./test
      dockerfile: Dockerfile.generator
    container_name: logsense-test-generator
    environment:
      INGESTION_URL: http://log-ingestion:8000
      LOGS_PER_SECOND: "10"
    profiles:
      - test
    depends_on:
      - log-ingestion

volumes:
  uptime-kuma-data:
  grafana-data:

networks:
  default:
    name: logsense-network
